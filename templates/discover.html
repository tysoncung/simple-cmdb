{% extends "base.html" %}

{% block title %}Discovery - Simple CMDB{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="bi bi-search"></i> Discovery</h1>
        <hr>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-pc-display"></i> Local System Discovery</h5>
            </div>
            <div class="card-body">
                <p>Discover information about the current system including hostname, IP address, OS details, CPU, memory, and disk information.</p>
                <button class="btn btn-primary" onclick="discoverLocal()">
                    <i class="bi bi-search"></i> Discover Local System
                </button>
                <div id="localDiscoveryResult" class="mt-3"></div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-cloud-upload"></i> Import from CSV</h5>
            </div>
            <div class="card-body">
                <p>Import servers, applications, or services from a CSV file.</p>
                <form id="importForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label class="form-label">Select Type</label>
                        <select class="form-control" id="importType">
                            <option value="servers">Servers</option>
                            <option value="applications">Applications</option>
                            <option value="services">Services</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">CSV File</label>
                        <input type="file" class="form-control" id="csvFile" accept=".csv" required>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-upload"></i> Import CSV
                    </button>
                </form>
                <div id="importResult" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-network"></i> Network Discovery</h5>
            </div>
            <div class="card-body">
                <p>Scan network ranges to discover servers and services. This feature requires additional setup.</p>
                <form id="networkDiscoveryForm">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Network Range</label>
                            <input type="text" class="form-control" id="networkRange" placeholder="192.168.1.0/24">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Port Range</label>
                            <input type="text" class="form-control" id="portRange" placeholder="22,80,443,3306">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-info form-control">
                                <i class="bi bi-radar"></i> Scan Network
                            </button>
                        </div>
                    </div>
                </form>
                <div id="networkDiscoveryResult" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-clock-history"></i> Discovery History</h5>
            </div>
            <div class="card-body">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Type</th>
                            <th>Source</th>
                            <th>Items Discovered</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="discoveryHistory">
                        <tr>
                            <td colspan="5" class="text-center text-muted">No discovery history available</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function discoverLocal() {
    const resultDiv = document.getElementById('localDiscoveryResult');
    resultDiv.innerHTML = '<div class="alert alert-info">Discovering local system...</div>';

    fetch('/api/discover/local', {method: 'POST'})
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>Discovery Complete!</strong><br>
                        Server: ${data.server.hostname}<br>
                        IP: ${data.server.ip_address}<br>
                        OS: ${data.server.os_type} ${data.server.os_version}<br>
                        <a href="/server/${data.server.id}" class="btn btn-sm btn-primary mt-2">View Server</a>
                    </div>
                `;
                loadDiscoveryHistory();
            } else {
                resultDiv.innerHTML = `<div class="alert alert-danger">Discovery failed: ${data.error}</div>`;
            }
        })
        .catch(error => {
            resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${error}</div>`;
        });
}

document.getElementById('importForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData();
    const fileInput = document.getElementById('csvFile');
    const importType = document.getElementById('importType').value;

    formData.append('file', fileInput.files[0]);
    formData.append('type', importType);

    const resultDiv = document.getElementById('importResult');
    resultDiv.innerHTML = '<div class="alert alert-info">Importing data...</div>';

    fetch('/api/import/csv', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <strong>Import Complete!</strong><br>
                    Imported: ${data.imported} items<br>
                    ${data.errors > 0 ? `Errors: ${data.errors}` : ''}
                </div>
            `;
            loadDiscoveryHistory();
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">Import failed: ${data.error}</div>`;
        }
    })
    .catch(error => {
        resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${error}</div>`;
    });
});

document.getElementById('networkDiscoveryForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const networkRange = document.getElementById('networkRange').value;
    const portRange = document.getElementById('portRange').value;

    const resultDiv = document.getElementById('networkDiscoveryResult');
    resultDiv.innerHTML = '<div class="alert alert-warning">Network discovery is not yet implemented. This would require additional network scanning tools.</div>';
});

function loadDiscoveryHistory() {
    fetch('/api/discovery/history')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('discoveryHistory');
            if (data.history && data.history.length > 0) {
                tbody.innerHTML = data.history.map(item => `
                    <tr>
                        <td>${item.created_at}</td>
                        <td>${item.discovery_type}</td>
                        <td>${item.source}</td>
                        <td>${item.items_discovered}</td>
                        <td>
                            <span class="badge bg-${item.status === 'success' ? 'success' : 'warning'}">
                                ${item.status}
                            </span>
                        </td>
                    </tr>
                `).join('');
            }
        })
        .catch(error => {
            console.error('Error loading discovery history:', error);
        });
}

// Load discovery history on page load
window.addEventListener('load', loadDiscoveryHistory);
</script>
{% endblock %}