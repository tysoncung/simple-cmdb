{% extends "base.html" %}

{% block title %}Services - Simple CMDB{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="bi bi-gear-wide-connected"></i> Services</h1>
        <hr>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-6">
        <input type="text" class="form-control" id="searchInput" placeholder="Search services..." onkeyup="filterServices()">
    </div>
    <div class="col-md-6 text-end">
        <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#addServiceModal">
            <i class="bi bi-plus-circle"></i> Add Service
        </button>
        <a href="/api/export/services" class="btn btn-secondary">
            <i class="bi bi-download"></i> Export CSV
        </a>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <table class="table table-hover" id="servicesTable">
                    <thead>
                        <tr>
                            <th>Service Name</th>
                            <th>Server</th>
                            <th>Application</th>
                            <th>Port</th>
                            <th>Protocol</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for service in services %}
                        <tr>
                            <td>
                                <i class="bi bi-gear-fill"></i>
                                <strong>{{ service.name }}</strong>
                            </td>
                            <td>{{ service.server_name or 'N/A' }}</td>
                            <td>{{ service.app_name or 'N/A' }}</td>
                            <td>{{ service.port or 'N/A' }}</td>
                            <td>{{ service.protocol or 'N/A' }}</td>
                            <td>
                                <span class="badge bg-{{ 'success' if service.status == 'running' else 'warning' if service.status == 'stopped' else 'danger' }}">
                                    {{ service.status }}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="viewService({{ service.id }})">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteService({{ service.id }})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Service Modal -->
<div class="modal fade" id="addServiceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Service</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addServiceForm">
                    <div class="mb-3">
                        <label class="form-label">Service Name *</label>
                        <input type="text" class="form-control" id="service_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Server</label>
                        <select class="form-control" id="server_id">
                            <option value="">Select server...</option>
                            {% for server in servers %}
                            <option value="{{ server.id }}">{{ server.hostname }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Application</label>
                        <select class="form-control" id="application_id">
                            <option value="">Select application...</option>
                            {% for app in applications %}
                            <option value="{{ app.id }}">{{ app.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Port</label>
                        <input type="number" class="form-control" id="port" min="1" max="65535">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Protocol</label>
                        <select class="form-control" id="protocol">
                            <option value="tcp">TCP</option>
                            <option value="udp">UDP</option>
                            <option value="http">HTTP</option>
                            <option value="https">HTTPS</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-control" id="status">
                            <option value="running">Running</option>
                            <option value="stopped">Stopped</option>
                            <option value="failed">Failed</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addService()">Add Service</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function filterServices() {
    const input = document.getElementById('searchInput');
    const filter = input.value.toUpperCase();
    const table = document.getElementById('servicesTable');
    const tr = table.getElementsByTagName('tr');

    for (let i = 1; i < tr.length; i++) {
        let visible = false;
        const td = tr[i].getElementsByTagName('td');
        for (let j = 0; j < td.length; j++) {
            if (td[j] && td[j].textContent.toUpperCase().indexOf(filter) > -1) {
                visible = true;
            }
        }
        tr[i].style.display = visible ? '' : 'none';
    }
}

function addService() {
    const data = {
        name: document.getElementById('service_name').value,
        server_id: document.getElementById('server_id').value,
        application_id: document.getElementById('application_id').value,
        port: document.getElementById('port').value,
        protocol: document.getElementById('protocol').value,
        status: document.getElementById('status').value
    };

    fetch('/api/service/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function viewService(id) {
    window.location.href = `/service/${id}`;
}

function deleteService(id) {
    if (confirm('Are you sure you want to delete this service?')) {
        fetch(`/api/service/${id}`, {method: 'DELETE'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            });
    }
}
</script>
{% endblock %}